rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 訪客統計 - 所有人可讀寫（用於匿名訪客計數）
    match /visitorStats/{docId} {
      allow read: if true;
      allow write: if true;
    }
    
    // 工具使用統計 - 所有人可讀寫（用於追蹤工具點擊）
    match /toolUsageStats/{toolId} {
      allow read: if true;
      allow write: if true;
    }
    
    // 錯誤日誌 - 所有人可寫（用於前端錯誤回報），僅認證用戶可讀
    match /errorLogs/{logId} {
      allow create: if true;
      allow read, update, delete: if request.auth != null;
    }
    
    // 成就系統 - 所有人可讀，僅認證用戶可寫
    match /achievements/{achievementId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // 用戶成就 - 需要認證
    match /userAchievements/{docId} {
      allow read, write: if request.auth != null;
    }
    
    // ==================== 評論功能 ====================
    
    // 工具評論 - 所有人可讀，認證用戶可寫
    match /toolReviews/{reviewId} {
      // 所有人可讀
      allow read: if true;
      // 認證用戶可新增
      allow create: if request.auth != null;
      // 只有評論作者可編輯/刪除，或任何認證用戶可更新點讚
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.userId ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'likedBy'])
      );
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // 工具評分統計 - 所有人可讀，系統可寫
    match /toolRatings/{toolId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // ==================== 許願池 ====================
    
    match /wishingWell/{wishId} {
      // 所有人都可以提交新許願
      allow create: if true;
      // 只有登入者（管理員）可以讀取、更新、刪除
      // 注意：實測建議確認 request.auth.uid 是否在管理員清單中
      allow read, update, delete: if request.auth != null;
    }
  }
}
