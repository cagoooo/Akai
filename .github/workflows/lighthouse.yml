name: Lighthouse CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for deployment
        # ç­‰å¾… GitHub Pages éƒ¨ç½²å®Œæˆ
        run: sleep 30

      - name: Run Lighthouse
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://cagoooo.github.io/Akai/
          budgetPath: ./budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Format Lighthouse Score
        id: format_lighthouse_score
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('.lighthouseci/manifest.json', 'utf8'));
            const summary = results[0]?.summary || {};
            
            const formatScore = (score) => {
              if (!score) return 'â“';
              const value = Math.round(score * 100);
              if (value >= 90) return `ðŸŸ¢ ${value}`;
              if (value >= 50) return `ðŸŸ¡ ${value}`;
              return `ðŸ”´ ${value}`;
            };
            
            const output = `
            ## Lighthouse æ•ˆèƒ½å ±å‘Š
            
            | æŒ‡æ¨™ | åˆ†æ•¸ |
            |------|------|
            | Performance | ${formatScore(summary.performance)} |
            | Accessibility | ${formatScore(summary.accessibility)} |
            | Best Practices | ${formatScore(summary['best-practices'])} |
            | SEO | ${formatScore(summary.seo)} |
            `;
            
            console.log(output);

      - name: Upload Lighthouse Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: .lighthouseci/
          retention-days: 30
